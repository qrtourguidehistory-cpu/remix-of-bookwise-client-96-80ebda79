import{r as n,x as o}from"./index-CzloO7cy.js";let E=null,A=0;const M=5*60*1e3;function B(){const[t,q]=n.useState(E||[]),[w,p]=n.useState(!E),[C,D]=n.useState(null),d=n.useCallback(async(U=!1)=>{const h=Date.now();if(!U&&E&&h-A<M){q(E),p(!1);return}try{p(!0),D(null);const{data:_,error:m}=await o.from("businesses").select("id, business_name, description, address, phone, email, average_rating, total_reviews, logo_url, cover_image_url, primary_category, category, secondary_categories, slug, is_public, is_active, created_at").eq("is_public",!0).eq("is_active",!0).order("created_at",{ascending:!1}).limit(100);if(m)throw console.error("Error fetching businesses:",m),m;const N=(_||[]).map(e=>({id:e.id,name:e.business_name||"Sin nombre",description:e.description,address:e.address,phone:e.phone,email:e.email,rating:Number(e.average_rating)||0,review_count:e.total_reviews||0,main_image:e.logo_url||e.cover_image_url,category:e.primary_category||e.category,primary_category:e.primary_category,secondary_categories:e.secondary_categories||[],slug:e.slug,is_public:e.is_public??!0,is_active:e.is_active??!0}));E=N,A=h,q(N)}catch(_){D(_.message),console.error("Error fetching establishments:",_)}finally{p(!1)}},[]);return n.useEffect(()=>{d()},[d]),{establishments:t,loading:w,error:C,refetch:d}}function F(t){const[q,w]=n.useState(null),[p,C]=n.useState([]),[D,d]=n.useState([]),[U,h]=n.useState([]),[_,m]=n.useState(!0),[N,e]=n.useState(null),v=n.useCallback(async()=>{var R,P,f;if(t)try{m(!0);const y=r=>{const c=r.price_currency||"DOP",b=Number(r.price||0);let S=0;if(r.price_usd!=null&&r.price_usd!==void 0){const i=String(r.price_usd).trim();if(i!==""&&i!=="null"&&i!=="undefined"){const g=parseFloat(i);!isNaN(g)&&isFinite(g)&&(S=g)}}let l=0,u=0;c==="USD"||c==="$"?(u=b,l=S):(l=b,u=S);const a={...r,duration:r.duration_minutes||r.duration||30,price:b,price_currency:c,currency:c};return a.price_rd=Number(l)||0,a.price_usd=Number(u)||0,a},{data:s,error:O}=await o.from("businesses").select("*").eq("id",t).maybeSingle();if(s){w({id:s.id,name:s.business_name||"Sin nombre",description:s.description,address:s.address,phone:s.phone,email:s.email,rating:Number(s.average_rating)||0,review_count:s.total_reviews||0,main_image:s.logo_url||s.cover_image_url,category:s.primary_category||s.category,primary_category:s.primary_category,secondary_categories:s.secondary_categories||[],slug:s.slug,is_public:s.is_public??!0,is_active:s.is_active??!0});const[r,c,b,S]=await Promise.all([o.from("services").select("*").eq("business_id",t).eq("is_active",!0).order("display_order",{nullsFirst:!1}).order("name",{ascending:!0}),o.from("business_services").select("*").eq("business_id",t).eq("is_active",!0),o.from("staff").select("*").eq("business_id",t).eq("is_active",!0),o.from("payment_methods").select("*").eq("business_id",t).eq("is_active",!0)]);r.error&&console.error("Error fetching services:",r.error),c.error&&console.error("Error fetching business_services:",c.error),console.log("Services result:",{data:r.data,error:r.error,count:((R=r.data)==null?void 0:R.length)||0});const l=new Map;(r.data||[]).forEach(a=>{const i=y(a);l.set(i.id,i)}),(c.data||[]).forEach(a=>{const i=y({...a,duration_minutes:a.duration_minutes||30});l.has(i.id)||l.set(i.id,i)});const u=Array.from(l.values()).sort((a,i)=>{const g=a.display_order??999,$=i.display_order??999;return g!==$?g-$:(a.name||"").localeCompare(i.name||"")});console.log("Services result count:",((P=r.data)==null?void 0:P.length)||0),console.log("Business services result count:",((f=c.data)==null?void 0:f.length)||0),console.log("All services after transformation (unique):",u.length),console.log("Service names:",u.map(a=>a.name)),console.log("Service IDs:",u.map(a=>a.id)),C(u),d(b.data||[]),h(S.data||[])}else e("Establecimiento no encontrado")}catch(y){e(y.message),console.error("Error fetching establishment:",y)}finally{m(!1)}},[t]);return n.useEffect(()=>{if(!t){w(null),C([]),d([]),h([]),m(!1);return}v();const R=o.channel(`services-${t}`).on("postgres_changes",{event:"*",schema:"public",table:"services",filter:`business_id=eq.${t}`},f=>{console.log("Services changed:",f),v()}).subscribe(),P=o.channel(`staff-${t}`).on("postgres_changes",{event:"*",schema:"public",table:"staff",filter:`business_id=eq.${t}`},f=>{console.log("Staff changed:",f),v()}).subscribe();return()=>{o.removeChannel(R),o.removeChannel(P)}},[t,v]),{establishment:q,services:p,staff:D,paymentMethods:U,loading:_,error:N,refetch:v}}export{F as a,B as u};
