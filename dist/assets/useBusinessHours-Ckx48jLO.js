import{r as E,s as b}from"./index-uyy-nLXi.js";async function y(r,t=3e4,e="La petición tardó demasiado tiempo"){const n=new AbortController,i=setTimeout(()=>n.abort(),t);try{const o=await Promise.race([r,new Promise((u,l)=>{setTimeout(()=>{l(new Error(e))},t)})]);return clearTimeout(i),o}catch(o){throw clearTimeout(i),o.name==="AbortError"||o.message===e?new Error("La conexión se perdió o tardó demasiado. Por favor, intenta de nuevo."):o}}function w(r,t,e){let n=0;const i=5;let o=null,u=null;const l=()=>(u&&r.removeChannel(u),u=r.channel(t).on("postgres_changes",{event:e.event||"*",schema:"public",table:e.table,filter:e.filter},c=>{try{e.onEvent(c),n=0}catch(a){console.error(`Error en handler de realtime para ${t}:`,a),e.onError&&e.onError(a)}}).subscribe(c=>{if(console.log(`[Realtime] ${t} - Status:`,c),c==="SUBSCRIBED")n=0,e.onSubscribe&&e.onSubscribe();else if(c==="CHANNEL_ERROR"||c==="TIMED_OUT")if(console.error(`[Realtime] ${t} - Error o timeout, intentando reconectar...`),n<i){n++;const a=Math.min(1e3*Math.pow(2,n),3e4);e.onError&&e.onError(new Error(`Error de conexión. Reintentando en ${a}ms...`)),o=setTimeout(()=>{console.log(`[Realtime] ${t} - Reintentando conexión (intento ${n}/${i})`),l()},a)}else console.error(`[Realtime] ${t} - Máximo de intentos de reconexión alcanzado`),e.onError&&e.onError(new Error("No se pudo establecer la conexión. Por favor, recarga la página."))}),u);return l(),()=>{o&&clearTimeout(o),u&&(r.removeChannel(u),u=null)}}async function S(r,t=2e4){try{return await y(r,t,"La consulta tardó demasiado tiempo")}catch(e){return console.error("Error en queryWithTimeout:",e),{data:null,error:{message:e.message||"Error de conexión",details:"La petición se agotó. Por favor, verifica tu conexión a internet.",code:"TIMEOUT"}}}}function R(r,t){const[e,n]=E.useState(null),[i,o]=E.useState([]),[u,l]=E.useState(!0),c=E.useCallback(async()=>{if(!r){l(!1);return}try{const a=b.from("business_hours").select("*").eq("business_id",r),m=await S(a,2e4),{data:s,error:d}=m;if(!d&&s&&s.length>0){o(s.map(f=>({day_of_week:f.day_of_week,is_open:!f.is_closed,start_time:f.open_time,end_time:f.close_time,lunch_start:f.break_start||null,lunch_end:f.break_end||null}))),l(!1);return}o([])}catch(a){console.error("Error fetching business hours:",a)}finally{l(!1)}},[r]);return E.useEffect(()=>{if(c(),r)return w(b,`business-hours-${r}`,{table:"business_hours",filter:`business_id=eq.${r}`,event:"*",onEvent:m=>{console.log("Business hours changed:",m),c()},onError:m=>{console.error("Error en suscripción de business hours:",m)}})},[r,c]),E.useEffect(()=>{if(i.length===0){n(null);return}const m=(t||new Date).getDay(),s=i.find(d=>d.day_of_week===m);if(s&&s.is_open!==!1){const d=p=>p?p.substring(0,5):"09:00",_=d(s.start_time),f=d(s.end_time),T=s.lunch_start?d(s.lunch_start):void 0,v=s.lunch_end?d(s.lunch_end):void 0;n({openTime:_,closeTime:f,lunchStart:T,lunchEnd:v,intervalMinutes:30})}else n(null)},[i,t]),{hours:e,loading:u,isClosed:i.length>0&&!e}}const h={"63806887-1f0e-4292-84a0-8a3ce5f560d2":{openTime:"09:00",closeTime:"20:00",lunchStart:"12:00",lunchEnd:"14:00",intervalMinutes:30},"98a62228-373f-45fc-bbb5-52700c61ff6e":{openTime:"08:00",closeTime:"21:00",lunchStart:"13:00",lunchEnd:"14:00",intervalMinutes:30},default:{openTime:"09:00",closeTime:"20:00",lunchStart:"12:00",lunchEnd:"14:00",intervalMinutes:30}};function x(r){return r&&h[r]?h[r]:h.default}export{x as g,R as u};
