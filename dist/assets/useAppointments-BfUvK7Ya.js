import{a as K,r as y,x as p,Q as L}from"./index-CuCDr45z.js";const B=t=>/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(t),W=(t,i)=>{const[c,$]=t.split(":").map(Number),v=c*60+$+i,D=Math.floor(v/60)%24,R=v%60;return`${D.toString().padStart(2,"0")}:${R.toString().padStart(2,"0")}`},X=t=>t.map(i=>{const c=i.businesses,$=c?{id:c.id,name:c.business_name||"Sin nombre",main_image:c.logo_url||c.cover_image_url,address:c.address}:null,v=(i.appointment_services||[]).map(b=>{const a=b.services;if(!a||!a.id)return{id:b.service_id||"",name:"Servicio",price:0,price_rd:0,price_usd:0,duration_minutes:0,currency:"DOP"};const f=a.price_currency||"DOP",q=E=>{if(E==null||E===void 0)return 0;if(typeof E=="number")return isNaN(E)?0:E;if(typeof E=="string"){const A=E.trim();if(A===""||A==="null"||A==="undefined")return 0;const T=parseFloat(A);return isNaN(T)?0:T}return 0},x=q(a.price),M=q(a.price_usd),O=q(a.duration_minutes);let C=0,w=0;return f==="USD"||f==="$"?(w=x,C=M):(C=x,w=M),{id:a.id||b.service_id||"",name:a.name||"Servicio",price:x,price_rd:C,price_usd:w,duration_minutes:O,currency:f}}),D=v.reduce((b,a)=>b+(Number(a.price_rd)||0),0),R=v.reduce((b,a)=>b+(Number(a.price_usd)||0),0),I=v.length>0?v[0].currency:"RD$";return{...i,establishment:$,staff:i.staff,services:v.length>0?v:void 0,price_currency:I,price_rd:D,price_usd:R}});function Z(){const{user:t,profile:i}=K(),[c,$]=y.useState([]),[v,D]=y.useState(!0),[R,I]=y.useState(null),[b,a]=y.useState(!1),f=y.useCallback(async()=>{try{D(!0);let e=p.from("appointments").select(`
          *,
          businesses:business_id (id, business_name, logo_url, cover_image_url, address),
          staff:staff_id (id, full_name),
          appointment_services (
            service_id,
            price,
            services:service_id (
              id,
              name,
              duration_minutes,
              price,
              price_currency,
              price_usd
            )
          ),
          services:service_id (
            id,
            price,
            price_currency,
            price_usd
          )
        `);t!=null&&t.id?e=e.eq("user_id",t.id):i!=null&&i.email&&(e=e.eq("client_email",i.email));const{data:r,error:n}=await e.order("date",{ascending:!1}).order("start_time",{ascending:!1});if(n)throw console.error("Error fetching appointments:",n),n;if(r&&r.length>0&&(t!=null&&t.id||i!=null&&i.email)){const l=r.length;if(l>=15){if(a(!0),l>15){const d=r.filter(u=>u.status==="completed").sort((u,_)=>{const h=new Date(`${u.date} ${u.start_time||"00:00"}`),s=new Date(`${_.date} ${_.start_time||"00:00"}`);return h.getTime()-s.getTime()}),S=l-15,o=d.slice(0,Math.min(S,d.length));if(o.length>0){console.log(`Auto-cleaning ${o.length} old completed appointments to maintain 15-appointment limit`);const u=o.map(s=>p.from("appointments").delete().eq("id",s.id));await Promise.all(u);const{data:_,error:h}=await e.order("date",{ascending:!1}).order("start_time",{ascending:!1});if(!h&&_){const s=X(_);$(s),a(_.length>=15),D(!1);return}}}}else a(!1)}const g=(r||[]).map(l=>{const d=l.businesses,S=d?{id:d.id,name:d.business_name||"Sin nombre",main_image:d.logo_url||d.cover_image_url,address:d.address}:null,o=(l.appointment_services||[]).map(s=>{const m=s.services;if(!m||!m.id)return{id:s.service_id||"",name:"Servicio",price:0,price_rd:0,price_usd:0,duration_minutes:0,currency:"DOP"};const P=m.price_currency||"DOP",z=N=>{if(N==null||N===void 0)return 0;if(typeof N=="number")return isNaN(N)?0:N;if(typeof N=="string"){const U=N.trim();if(U===""||U==="null"||U==="undefined")return 0;const J=parseFloat(U);return isNaN(J)?0:J}return 0},F=z(m.price),k=z(m.price_usd),G=z(m.duration_minutes);let H=0,V=0;return P==="USD"||P==="$"?(V=F,H=k):(H=F,V=k),{id:m.id||s.service_id||"",name:m.name||"Servicio",price:F,price_rd:H,price_usd:V,duration_minutes:G,currency:P}}),u=o.reduce((s,m)=>s+(Number(m.price_rd)||0),0),_=o.reduce((s,m)=>s+(Number(m.price_usd)||0),0),h=o.length>0?o[0].currency:"RD$";return{...l,establishment:S,staff:l.staff,services:o.length>0?o:void 0,price_currency:h,price_rd:u,price_usd:_}});$(g)}catch(e){I(e.message),console.error("Error fetching appointments:",e)}finally{D(!1)}},[t==null?void 0:t.id,i==null?void 0:i.email]),q=async e=>{var r;try{let n=e.establishment_id;if(console.log("Creating appointment with business_id:",n),!B(n))throw new Error("Invalid business ID provided");const{data:g}=await p.from("businesses").select("id").eq("id",n).maybeSingle();if(!g)throw new Error("Business not found");console.log("Business verified:",n);const l=W(e.start_time,e.duration_minutes);let d=e.staff_id||null;d&&!B(d)&&(d=null);const S=((r=e.services.find(h=>B(h.id)))==null?void 0:r.id)||null,o={user_id:(t==null?void 0:t.id)||null,staff_id:d,service_id:S,client_name:e.client_name,client_email:e.client_email||null,client_phone:e.client_phone||null,date:e.date,start_time:e.start_time,end_time:l,notes:e.notes||null,price:e.price,duration_minutes:e.duration_minutes,status:"pending"};o.business_id=n,console.log("Saving appointment with business_id:",n),console.log("Insert data:",JSON.stringify(o,null,2));const{data:u,error:_}=await p.from("appointments").insert(o).select().single();if(_)throw console.error("Error inserting appointment:",_),_;if(console.log("Appointment created successfully:",u),e.services.length>0&&u){const h=e.services.filter(s=>B(s.id));if(h.length>0){const s=h.map(P=>({appointment_id:u.id,service_id:P.id,price:P.price})),{error:m}=await p.from("appointment_services").insert(s);m?(console.error("Error inserting services:",m),console.warn("Services were not saved to appointment_services, but appointment was created with service_id:",S)):console.log("Successfully saved",h.length,"service(s) to appointment_services")}}return await f(),{data:u,error:null}}catch(n){return console.error("Error creating appointment:",n),{data:null,error:n.message}}},x=async e=>{try{console.log("Cancelling appointment:",e);const{data:r,error:n}=await p.from("appointments").select("id, status").eq("id",e).maybeSingle();if(n)throw console.error("Error fetching appointment:",n),new Error(`Error al buscar la cita: ${n.message}`);if(!r)throw new Error("La cita no existe en el sistema");console.log("Found appointment:",r);const{error:g}=await p.from("appointments").update({status:"cancelled"}).eq("id",e);if(g)throw console.error("Supabase update error:",g),new Error(`Error al actualizar: ${g.message}`);return console.log("Appointment cancelled successfully"),L({title:"Cita cancelada",description:"Tu cita ha sido cancelada exitosamente."}),await f(),{success:!0}}catch(r){return console.error("Error cancelling appointment:",r),L({title:"Error",description:`No se pudo cancelar la cita: ${r.message}`,variant:"destructive"}),{success:!1,error:r.message}}},M=async(e,r)=>{try{const{error:n}=await p.from("appointments").update(r).eq("id",e);if(n)throw n;return await f(),{success:!0}}catch(n){return{success:!1,error:n.message}}},O=async e=>{try{const{error:r}=await p.from("appointments").update({early_confirmed:!0}).eq("id",e);if(r)throw r;return await f(),{success:!0}}catch(r){return console.error("Error confirming early arrival:",r),{success:!1,error:r.message}}},C=async e=>{try{console.log("Deleting appointment:",e);const{data:r,error:n}=await p.from("appointments").select("id, user_id, client_email").eq("id",e).maybeSingle();if(n)throw console.error("Error fetching appointment:",n),new Error(`Error al buscar la cita: ${n.message}`);if(!r)throw new Error("La cita no existe en el sistema");if(t!=null&&t.id&&r.user_id!==t.id)throw new Error("No tienes permiso para eliminar esta cita");if(!(t!=null&&t.id)&&(i!=null&&i.email)&&r.client_email!==i.email)throw new Error("No tienes permiso para eliminar esta cita");const{error:g}=await p.from("appointment_services").delete().eq("appointment_id",e);g&&console.warn("Error deleting appointment services (may not exist):",g);const{error:l}=await p.from("appointments").delete().eq("id",e);if(l)throw console.error("Supabase delete error:",l),new Error(`Error al eliminar: ${l.message}`);return console.log("Appointment deleted successfully"),L({title:"Cita eliminada",description:"La cita ha sido eliminada de tu historial exitosamente."}),await f(),{success:!0}}catch(r){return console.error("Error deleting appointment:",r),L({title:"Error",description:`No se pudo eliminar la cita: ${r.message}`,variant:"destructive"}),{success:!1,error:r.message}}},w=y.useRef(null),E=y.useRef(`appointments-${Date.now()}-${Math.random().toString(36).substring(7)}`);y.useEffect(()=>{f(),w.current&&(p.removeChannel(w.current),w.current=null);const e=`appointments-${(t==null?void 0:t.id)||"anon"}-${Date.now()}`;E.current=e;const r=p.channel(e).on("postgres_changes",{event:"*",schema:"public",table:"appointments"},n=>{console.log("Appointment changed:",n),f()}).subscribe();return w.current=r,()=>{w.current&&(p.removeChannel(w.current),w.current=null)}},[t==null?void 0:t.id,i==null?void 0:i.email,f]);const A=(e,r)=>{if(!e)return!1;const g=new Date().getTime(),[l,d,S]=e.split("-").map(Number);let o=0,u=0;if(r){const s=r.split(":").map(Number);o=s[0]||0,u=s[1]||0}return new Date(l,d-1,S,o,u,0,0).getTime()>g},T=y.useMemo(()=>c.filter(e=>(e.status==="confirmed"||e.status==="pending")&&A(e.date,e.start_time)),[c]),Q=y.useMemo(()=>c.filter(e=>!!(e.status==="completed"||e.status==="cancelled"||e.status!=="completed"&&e.date&&!A(e.date,e.start_time))),[c]),j=y.useMemo(()=>c.filter(e=>e.status==="cancelled"),[c]);return{appointments:c,upcomingAppointments:T,pastAppointments:Q,cancelledAppointments:j,loading:v,error:R,historyLimitReached:b,createAppointment:q,cancelAppointment:x,updateAppointment:M,deleteAppointment:C,confirmEarlyArrival:O,refetch:f}}export{Z as u};
