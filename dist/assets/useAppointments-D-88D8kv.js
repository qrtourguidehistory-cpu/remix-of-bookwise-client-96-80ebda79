import{a as W,r as m,s as a,J as $}from"./index-DdwKk-nk.js";const N=t=>/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(t),X=(t,s)=>{const[p,q]=t.split(":").map(Number),b=p*60+q+s,S=Math.floor(b/60)%24,C=b%60;return`${S.toString().padStart(2,"0")}:${C.toString().padStart(2,"0")}`};function Z(){const{user:t,profile:s}=W(),[p,q]=m.useState([]),[b,S]=m.useState(!0),[C,L]=m.useState(null),[O,M]=m.useState(!1),f=m.useCallback(async()=>{try{S(!0);let e=a.from("appointments").select(`
          *,
          businesses:business_id (id, business_name, logo_url, cover_image_url, address),
          staff:staff_id (id, full_name),
          appointment_services (
            service_id,
            price,
            services:service_id (
              id,
              name,
              duration_minutes,
              price,
              price_currency,
              price_usd
            )
          ),
          services:service_id (
            id,
            price,
            price_currency,
            price_usd
          )
        `);t!=null&&t.id?e=e.eq("user_id",t.id):s!=null&&s.email&&(e=e.eq("client_email",s.email));const{data:r,error:n}=await e.order("date",{ascending:!1}).order("start_time",{ascending:!1});if(n)throw console.error("Error fetching appointments:",n),n;const c=(r||[]).map(i=>{const o=i.businesses,_=o?{id:o.id,name:o.business_name||"Sin nombre",main_image:o.logo_url||o.cover_image_url,address:o.address}:null,u=(i.appointment_services||[]).map(d=>{const l=d.services;if(!l||!l.id)return{id:d.service_id||"",name:"Servicio",price:0,price_rd:0,price_usd:0,duration_minutes:0,currency:"DOP"};const y=l.price_currency||"DOP",D=v=>{if(v==null||v===void 0)return 0;if(typeof v=="number")return isNaN(v)?0:v;if(typeof v=="string"){const A=v.trim();if(A===""||A==="null"||A==="undefined")return 0;const I=parseFloat(A);return isNaN(I)?0:I}return 0},x=D(l.price),F=D(l.price_usd),Q=D(l.duration_minutes);let T=0,R=0;return y==="USD"||y==="$"?(R=x,T=F):(T=x,R=F),{id:l.id||d.service_id||"",name:l.name||"Servicio",price:x,price_rd:T,price_usd:R,duration_minutes:Q,currency:y}}),g=u.reduce((d,l)=>d+(Number(l.price_rd)||0),0),E=u.reduce((d,l)=>d+(Number(l.price_usd)||0),0),h=u.length>0?u[0].currency:"RD$";return{...i,establishment:_,staff:i.staff,services:u.length>0?u:void 0,price_currency:h,price_rd:g,price_usd:E}});q(c)}catch(e){L(e.message),console.error("Error fetching appointments:",e)}finally{S(!1)}},[t==null?void 0:t.id,s==null?void 0:s.email]),z=async e=>{var r;try{let n=e.establishment_id;if(console.log("Creating appointment with business_id:",n),!N(n))throw new Error("Invalid business ID provided");const{data:c}=await a.from("businesses").select("id").eq("id",n).maybeSingle();if(!c)throw new Error("Business not found");console.log("Business verified:",n);const i=X(e.start_time,e.duration_minutes);let o=e.staff_id||null;o&&!N(o)&&(o=null);const _=((r=e.services.find(h=>N(h.id)))==null?void 0:r.id)||null,u={user_id:(t==null?void 0:t.id)||null,staff_id:o,service_id:_,client_name:e.client_name,client_email:e.client_email||null,client_phone:e.client_phone||null,date:e.date,start_time:e.start_time,end_time:i,notes:e.notes||null,price:e.price,duration_minutes:e.duration_minutes,status:"pending"};u.business_id=n,console.log("Saving appointment with business_id:",n),console.log("Insert data:",JSON.stringify(u,null,2));const{data:g,error:E}=await a.from("appointments").insert(u).select().single();if(E)throw console.error("Error inserting appointment:",E),E;if(console.log("Appointment created successfully:",g),e.services.length>0&&g){const h=e.services.filter(d=>N(d.id));if(h.length>0){const d=h.map(y=>({appointment_id:g.id,service_id:y.id,price:y.price})),{error:l}=await a.from("appointment_services").insert(d);l?(console.error("Error inserting services:",l),console.warn("Services were not saved to appointment_services, but appointment was created with service_id:",_)):console.log("Successfully saved",h.length,"service(s) to appointment_services")}}return await f(),{data:g,error:null}}catch(n){return console.error("Error creating appointment:",n),{data:null,error:n.message}}},P=m.useCallback(async()=>{if(t!=null&&t.id)try{const{data:e,error:r}=await a.from("appointments").select("id, date, start_time, status, created_at").eq("user_id",t.id).in("status",["completed","cancelled"]).order("date",{ascending:!1}).order("start_time",{ascending:!1});if(r){console.error("Error fetching history for cleanup:",r);return}const n=(e==null?void 0:e.length)||0;if(n>=15){if(M(!0),n===15){const c=e.filter(i=>i.status==="completed").slice(15);if(c.length>0){const i=c.map(_=>_.id),{error:o}=await a.from("appointments").delete().in("id",i);o?console.error("Error auto-deleting old appointments:",o):(console.log(`ðŸ§¹ Auto-deleted ${i.length} old completed appointments`),f())}}}else M(!1)}catch(e){console.error("Error cleaning up old appointments:",e)}},[t==null?void 0:t.id]);m.useEffect(()=>{p.length>0&&P()},[p.length,P]);const B=async e=>{try{console.log("Cancelling appointment:",e);const{data:r,error:n}=await a.from("appointments").select("id, status").eq("id",e).maybeSingle();if(n)throw console.error("Error fetching appointment:",n),new Error(`Error al buscar la cita: ${n.message}`);if(!r)throw new Error("La cita no existe en el sistema");console.log("Found appointment:",r);const{error:c}=await a.from("appointments").update({status:"cancelled"}).eq("id",e);if(c)throw console.error("Supabase update error:",c),new Error(`Error al actualizar: ${c.message}`);return console.log("Appointment cancelled successfully"),$({title:"Cita cancelada",description:"Tu cita ha sido cancelada exitosamente."}),await f(),{success:!0}}catch(r){return console.error("Error cancelling appointment:",r),$({title:"Error",description:`No se pudo cancelar la cita: ${r.message}`,variant:"destructive"}),{success:!1,error:r.message}}},k=async(e,r)=>{try{const{error:n}=await a.from("appointments").update(r).eq("id",e);if(n)throw n;return await f(),{success:!0}}catch(n){return{success:!1,error:n.message}}},H=async e=>{try{const{error:r}=await a.from("appointments").update({early_confirmed:!0}).eq("id",e);if(r)throw r;return await f(),{success:!0}}catch(r){return console.error("Error confirming early arrival:",r),{success:!1,error:r.message}}},J=async e=>{try{console.log("Deleting appointment:",e);const{data:r,error:n}=await a.from("appointments").select("id, user_id, client_email").eq("id",e).maybeSingle();if(n)throw console.error("Error fetching appointment:",n),new Error(`Error al buscar la cita: ${n.message}`);if(!r)throw new Error("La cita no existe en el sistema");if(t!=null&&t.id&&r.user_id!==t.id)throw new Error("No tienes permiso para eliminar esta cita");if(!(t!=null&&t.id)&&(s!=null&&s.email)&&r.client_email!==s.email)throw new Error("No tienes permiso para eliminar esta cita");const{error:c}=await a.from("appointment_services").delete().eq("appointment_id",e);c&&console.warn("Error deleting appointment services (may not exist):",c);const{error:i}=await a.from("appointments").delete().eq("id",e);if(i)throw console.error("Supabase delete error:",i),new Error(`Error al eliminar: ${i.message}`);return console.log("Appointment deleted successfully"),$({title:"Cita eliminada",description:"La cita ha sido eliminada de tu historial exitosamente."}),await f(),{success:!0}}catch(r){return console.error("Error deleting appointment:",r),$({title:"Error",description:`No se pudo eliminar la cita: ${r.message}`,variant:"destructive"}),{success:!1,error:r.message}}},w=m.useRef(null),V=m.useRef(`appointments-${Date.now()}-${Math.random().toString(36).substring(7)}`);m.useEffect(()=>{f(),w.current&&(a.removeChannel(w.current),w.current=null);const e=`appointments-${(t==null?void 0:t.id)||"anon"}-${Date.now()}`;V.current=e;const r=a.channel(e).on("postgres_changes",{event:"*",schema:"public",table:"appointments"},n=>{console.log("Appointment changed:",n),f()}).subscribe();return w.current=r,()=>{w.current&&(a.removeChannel(w.current),w.current=null)}},[t==null?void 0:t.id,s==null?void 0:s.email,f]);const U=(e,r)=>{if(!e)return!1;const c=new Date().getTime(),[i,o,_]=e.split("-").map(Number);let u=0,g=0;if(r){const d=r.split(":").map(Number);u=d[0]||0,g=d[1]||0}return new Date(i,o-1,_,u,g,0,0).getTime()>c},j=m.useMemo(()=>p.filter(e=>(e.status==="confirmed"||e.status==="pending")&&U(e.date,e.start_time)),[p]),G=m.useMemo(()=>p.filter(e=>!!(e.status==="completed"||e.status==="cancelled"||e.status!=="completed"&&e.date&&!U(e.date,e.start_time))),[p]),K=m.useMemo(()=>p.filter(e=>e.status==="cancelled"),[p]);return{appointments:p,upcomingAppointments:j,pastAppointments:G,cancelledAppointments:K,loading:b,error:C,historyFull:O,createAppointment:z,cancelAppointment:B,updateAppointment:k,deleteAppointment:J,confirmEarlyArrival:H,refetch:f}}export{Z as u};
