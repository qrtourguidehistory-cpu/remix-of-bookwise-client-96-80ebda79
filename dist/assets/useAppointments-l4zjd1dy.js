import{a as W,r as u,s as a,J as N}from"./index-uyy-nLXi.js";const x=r=>/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(r),X=(r,i)=>{const[p,T]=r.split(":").map(Number),q=p*60+T+i,$=Math.floor(q/60)%24,R=q%60;return`${$.toString().padStart(2,"0")}:${R.toString().padStart(2,"0")}`};function Z(){const{user:r,profile:i}=W(),[p,T]=u.useState([]),[q,$]=u.useState(!0),[R,L]=u.useState(null),[O,P]=u.useState(!1),f=u.useCallback(async()=>{try{$(!0);let e=a.from("appointments").select(`
          *,
          businesses:business_id (id, business_name, logo_url, cover_image_url, address),
          staff:staff_id (id, full_name),
          appointment_services (
            service_id,
            price,
            services:service_id (
              id,
              name,
              duration_minutes,
              price,
              price_currency,
              price_usd
            )
          ),
          services:service_id (
            id,
            price,
            price_currency,
            price_usd
          )
        `);r!=null&&r.id?e=e.eq("user_id",r.id):i!=null&&i.email&&(e=e.eq("client_email",i.email));const{data:t,error:n}=await e.order("date",{ascending:!1}).order("start_time",{ascending:!1});if(n)throw console.error("Error fetching appointments:",n),n;const l=(t||[]).map(s=>{const d=s.businesses,_=d?{id:d.id,name:d.business_name||"Sin nombre",main_image:d.logo_url||d.cover_image_url,address:d.address}:null,m=(s.appointment_services||[]).map(c=>{const o=c.services;if(!o||!o.id)return{id:c.service_id||"",name:"Servicio",price:0,price_rd:0,price_usd:0,duration_minutes:0,currency:"DOP"};const g=o.price_currency||"DOP",w=y=>{if(y==null||y===void 0)return 0;if(typeof y=="number")return isNaN(y)?0:y;if(typeof y=="string"){const C=y.trim();if(C===""||C==="null"||C==="undefined")return 0;const U=parseFloat(C);return isNaN(U)?0:U}return 0},S=w(o.price),A=w(o.price_usd),Q=w(o.duration_minutes);let D=0,M=0;return g==="USD"||g==="$"?(M=S,D=A):(D=S,M=A),{id:o.id||c.service_id||"",name:o.name||"Servicio",price:S,price_rd:D,price_usd:M,duration_minutes:Q,currency:g}}),h=m.reduce((c,o)=>c+(Number(o.price_rd)||0),0),E=m.reduce((c,o)=>c+(Number(o.price_usd)||0),0),b=m.length>0?m[0].currency:"RD$";return{...s,establishment:_,staff:s.staff,services:m.length>0?m:void 0,price_currency:b,price_rd:h,price_usd:E}});T(l)}catch(e){L(e.message),console.error("Error fetching appointments:",e)}finally{$(!1)}},[r==null?void 0:r.id,i==null?void 0:i.email]),k=async e=>{var t;try{let n=e.establishment_id;if(console.log("Creating appointment with business_id:",n),!x(n))throw new Error("Invalid business ID provided");const{data:l}=await a.from("businesses").select("id").eq("id",n).maybeSingle();if(!l)throw new Error("Business not found");console.log("Business verified:",n);let s=null;if(r!=null&&r.id){let c=a.from("clients").select("id").eq("user_id",r.id).eq("business_id",n);e.client_name&&(c=c.eq("full_name",e.client_name));const{data:o,error:g}=await c.maybeSingle();if(g&&g.code!=="PGRST116"&&console.error("Error searching for client:",g),o!=null&&o.id)s=o.id,console.log("Found existing client:",s);else{const w={user_id:r.id,business_id:n,full_name:e.client_name||(i==null?void 0:i.full_name)||null,first_name:null,last_name:null,email:e.client_email||(i==null?void 0:i.email)||null,phone:e.client_phone||(i==null?void 0:i.phone)||null,is_active:!0,is_blocked:!1},{data:S,error:A}=await a.from("clients").insert(w).select("id").single();A?(console.error("Error creating client:",A),console.warn("Could not create client record, proceeding without client_id")):(s=S.id,console.log("Created new client:",s))}}const d=X(e.start_time,e.duration_minutes);let _=e.staff_id||null;_&&!x(_)&&(_=null);const m=((t=e.services.find(c=>x(c.id)))==null?void 0:t.id)||null,h={user_id:(r==null?void 0:r.id)||null,client_id:s,staff_id:_,service_id:m,client_name:e.client_name,client_email:e.client_email||null,client_phone:e.client_phone||null,date:e.date,start_time:e.start_time,end_time:d,notes:e.notes||null,price:e.price,duration_minutes:e.duration_minutes,status:"pending"};h.business_id=n,console.log("Saving appointment with business_id:",n),console.log("Saving appointment with client_id:",s),console.log("Insert data:",JSON.stringify(h,null,2));const{data:E,error:b}=await a.from("appointments").insert(h).select().single();if(b)throw console.error("Error inserting appointment:",b),b;if(console.log("Appointment created successfully:",E),e.services.length>0&&E){const c=e.services.filter(o=>x(o.id));if(c.length>0){const o=c.map(w=>({appointment_id:E.id,service_id:w.id,price:w.price})),{error:g}=await a.from("appointment_services").insert(o);g?(console.error("Error inserting services:",g),console.warn("Services were not saved to appointment_services, but appointment was created with service_id:",m)):console.log("Successfully saved",c.length,"service(s) to appointment_services")}}return await f(),{data:E,error:null}}catch(n){return console.error("Error creating appointment:",n),{data:null,error:n.message}}},F=u.useCallback(async()=>{if(r!=null&&r.id)try{const{data:e,error:t}=await a.from("appointments").select("id, date, start_time, status, created_at").eq("user_id",r.id).in("status",["completed","cancelled"]).order("date",{ascending:!1}).order("start_time",{ascending:!1});if(t){console.error("Error fetching history for cleanup:",t);return}const n=(e==null?void 0:e.length)||0;if(n>=15){if(P(!0),n===15){const l=e.filter(s=>s.status==="completed").slice(15);if(l.length>0){const s=l.map(_=>_.id),{error:d}=await a.from("appointments").delete().in("id",s);d?console.error("Error auto-deleting old appointments:",d):(console.log(`ðŸ§¹ Auto-deleted ${s.length} old completed appointments`),f())}}}else P(!1)}catch(e){console.error("Error cleaning up old appointments:",e)}},[r==null?void 0:r.id]);u.useEffect(()=>{p.length>0&&F()},[p.length,F]);const z=async e=>{try{console.log("Cancelling appointment:",e);const{data:t,error:n}=await a.from("appointments").select("id, status").eq("id",e).maybeSingle();if(n)throw console.error("Error fetching appointment:",n),new Error(`Error al buscar la cita: ${n.message}`);if(!t)throw new Error("La cita no existe en el sistema");console.log("Found appointment:",t);const{error:l}=await a.from("appointments").update({status:"cancelled"}).eq("id",e);if(l)throw console.error("Supabase update error:",l),new Error(`Error al actualizar: ${l.message}`);return console.log("Appointment cancelled successfully"),N({title:"Cita cancelada",description:"Tu cita ha sido cancelada exitosamente."}),await f(),{success:!0}}catch(t){return console.error("Error cancelling appointment:",t),N({title:"Error",description:`No se pudo cancelar la cita: ${t.message}`,variant:"destructive"}),{success:!1,error:t.message}}},B=async(e,t)=>{try{const{error:n}=await a.from("appointments").update(t).eq("id",e);if(n)throw n;return await f(),{success:!0}}catch(n){return{success:!1,error:n.message}}},H=async e=>{try{const{error:t}=await a.from("appointments").update({early_confirmed:!0}).eq("id",e);if(t)throw t;return await f(),{success:!0}}catch(t){return console.error("Error confirming early arrival:",t),{success:!1,error:t.message}}},J=async e=>{try{console.log("Deleting appointment:",e);const{data:t,error:n}=await a.from("appointments").select("id, user_id, client_email").eq("id",e).maybeSingle();if(n)throw console.error("Error fetching appointment:",n),new Error(`Error al buscar la cita: ${n.message}`);if(!t)throw new Error("La cita no existe en el sistema");if(r!=null&&r.id&&t.user_id!==r.id)throw new Error("No tienes permiso para eliminar esta cita");if(!(r!=null&&r.id)&&(i!=null&&i.email)&&t.client_email!==i.email)throw new Error("No tienes permiso para eliminar esta cita");const{error:l}=await a.from("appointment_services").delete().eq("appointment_id",e);l&&console.warn("Error deleting appointment services (may not exist):",l);const{error:s}=await a.from("appointments").delete().eq("id",e);if(s)throw console.error("Supabase delete error:",s),new Error(`Error al eliminar: ${s.message}`);return console.log("Appointment deleted successfully"),N({title:"Cita eliminada",description:"La cita ha sido eliminada de tu historial exitosamente."}),await f(),{success:!0}}catch(t){return console.error("Error deleting appointment:",t),N({title:"Error",description:`No se pudo eliminar la cita: ${t.message}`,variant:"destructive"}),{success:!1,error:t.message}}},v=u.useRef(null),V=u.useRef(`appointments-${Date.now()}-${Math.random().toString(36).substring(7)}`);u.useEffect(()=>{f(),v.current&&(a.removeChannel(v.current),v.current=null);const e=`appointments-${(r==null?void 0:r.id)||"anon"}-${Date.now()}`;V.current=e;const t=a.channel(e).on("postgres_changes",{event:"*",schema:"public",table:"appointments"},n=>{console.log("Appointment changed:",n),f()}).subscribe();return v.current=t,()=>{v.current&&(a.removeChannel(v.current),v.current=null)}},[r==null?void 0:r.id,i==null?void 0:i.email,f]);const I=(e,t)=>{if(!e)return!1;const l=new Date().getTime(),[s,d,_]=e.split("-").map(Number);let m=0,h=0;if(t){const c=t.split(":").map(Number);m=c[0]||0,h=c[1]||0}return new Date(s,d-1,_,m,h,0,0).getTime()>l},G=u.useMemo(()=>p.filter(e=>(e.status==="confirmed"||e.status==="pending")&&I(e.date,e.start_time)),[p]),j=u.useMemo(()=>p.filter(e=>!!(e.status==="completed"||e.status==="cancelled"||e.status!=="completed"&&e.date&&!I(e.date,e.start_time))),[p]),K=u.useMemo(()=>p.filter(e=>e.status==="cancelled"),[p]);return{appointments:p,upcomingAppointments:G,pastAppointments:j,cancelledAppointments:K,loading:q,error:R,historyFull:O,createAppointment:k,cancelAppointment:z,updateAppointment:B,deleteAppointment:J,confirmEarlyArrival:H,refetch:f}}export{Z as u};
