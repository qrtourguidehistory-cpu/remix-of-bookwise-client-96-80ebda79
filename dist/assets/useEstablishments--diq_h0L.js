import{r as c,x as u}from"./index-CBIizFiU.js";let w=null,P=0;const U=5*60*1e3;function F(){const[i,q]=c.useState(w||[]),[h,b]=c.useState(!w),[C,D]=c.useState(null),p=c.useCallback(async(N=!1)=>{const v=Date.now();if(!N&&w&&v-P<U){q(w),b(!1);return}try{b(!0),D(null);const{data:y,error:g}=await u.from("businesses").select("id, business_name, description, address, phone, email, average_rating, total_reviews, logo_url, cover_image_url, primary_category, category, secondary_categories, slug, is_public, is_active, temporarily_closed, closed_until, google_maps_url, latitude, longitude, created_at").eq("is_public",!0).eq("is_active",!0).order("created_at",{ascending:!1}).limit(100);if(g)throw console.error("Error fetching businesses:",g),g;const $=(y||[]).map(s=>({id:s.id,name:s.business_name||"Sin nombre",description:s.description,address:s.address,phone:s.phone,email:s.email,rating:4.5,review_count:s.total_reviews||0,main_image:s.logo_url||s.cover_image_url,category:s.primary_category||s.category,primary_category:s.primary_category,secondary_categories:s.secondary_categories||[],slug:s.slug,is_public:s.is_public??!0,is_active:s.is_active??!0,temporarily_closed:s.temporarily_closed??!1,closed_until:s.closed_until??null,google_maps_url:s.google_maps_url??null,latitude:s.latitude??null,longitude:s.longitude??null}));w=$,P=v,q($)}catch(y){D(y.message),console.error("Error fetching establishments:",y)}finally{b(!1)}},[]);return c.useEffect(()=>{p()},[p]),{establishments:i,loading:h,error:C,refetch:p}}function M(i){const[q,h]=c.useState(null),[b,C]=c.useState([]),[D,p]=c.useState([]),[N,v]=c.useState([]),[y,g]=c.useState(!0),[$,s]=c.useState(null),_=c.useCallback(async()=>{if(i)try{g(!0);const f=n=>{const d=n.price_currency||"DOP",a=Number(n.price||0);let e=0;if(n.price_usd!=null&&n.price_usd!==void 0){const l=String(n.price_usd).trim();if(l!==""&&l!=="null"&&l!=="undefined"){const o=parseFloat(l);!isNaN(o)&&isFinite(o)&&(e=o)}}let r=0,m=0;d==="USD"||d==="$"?(m=a,r=e):(r=a,m=e);const S={...n,duration:n.duration_minutes||n.duration||30,price:a,price_currency:d,currency:d};return S.price_rd=Number(r)||0,S.price_usd=Number(m)||0,S},{data:t,error:E}=await u.from("businesses").select("*").eq("id",i).maybeSingle();if(E)throw console.error("Error fetching business:",E),E;if(t){const n={id:t.id,name:t.business_name||"Sin nombre",description:t.description,address:t.address,phone:t.phone,email:t.email,rating:4.5,review_count:t.total_reviews||0,main_image:t.logo_url||t.cover_image_url,category:t.primary_category||t.category,primary_category:t.primary_category,secondary_categories:t.secondary_categories||[],slug:t.slug,is_public:t.is_public??!0,is_active:t.is_active??!0,temporarily_closed:t.temporarily_closed??!1,closed_until:t.closed_until??null,google_maps_url:t.google_maps_url??null,latitude:t.latitude??null,longitude:t.longitude??null};h(n);const[d,a,e,r]=await Promise.all([u.from("services").select("*").eq("business_id",i).eq("is_active",!0).order("display_order",{nullsFirst:!1}).order("name",{ascending:!0}),u.from("business_services").select("*").eq("business_id",i).eq("is_active",!0),u.from("staff").select("*").eq("business_id",i).eq("is_active",!0),u.from("payment_methods").select("*").eq("business_id",i).eq("is_active",!0)]);d.error&&console.error("Error fetching services:",d.error),a.error&&console.error("Error fetching business_services:",a.error);const m=new Map;(d.data||[]).forEach(l=>{const o=f(l);m.set(o.id,o)}),(a.data||[]).forEach(l=>{const o=f({...l,duration_minutes:l.duration_minutes||30});m.has(o.id)||m.set(o.id,o)});const S=Array.from(m.values()).sort((l,o)=>{const R=l.display_order??999,L=o.display_order??999;return R!==L?R-L:(l.name||"").localeCompare(o.name||"")});C(S),p(e.data||[]),v(r.data||[])}else s("Establecimiento no encontrado")}catch(f){s(f.message),console.error("Error fetching establishment:",f)}finally{g(!1)}},[i]);return c.useEffect(()=>{if(!i){h(null),C([]),p([]),v([]),g(!1);return}_();const f=u.channel(`business-${i}-${Date.now()}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"businesses",filter:`id=eq.${i}`},a=>{console.log("ðŸ”„ Business data changed via Realtime:",a);const e=a.new;e&&h(r=>r&&{...r,name:e.business_name||r.name,description:e.description??r.description,address:e.address??r.address,phone:e.phone??r.phone,email:e.email??r.email,rating:Number(e.average_rating)||r.rating,review_count:e.total_reviews??r.review_count,main_image:e.logo_url||e.cover_image_url||r.main_image,category:e.primary_category||e.category||r.category,primary_category:e.primary_category??r.primary_category,secondary_categories:e.secondary_categories??r.secondary_categories,is_active:e.is_active??r.is_active,is_public:e.is_public??r.is_public,temporarily_closed:e.temporarily_closed??!1,closed_until:e.closed_until??null,latitude:e.latitude??r.latitude,longitude:e.longitude??r.longitude}),_()}).subscribe(),t=u.channel(`services-${i}`).on("postgres_changes",{event:"*",schema:"public",table:"services",filter:`business_id=eq.${i}`},a=>{console.log("Services changed:",a),_()}).subscribe(),E=u.channel(`staff-${i}`).on("postgres_changes",{event:"*",schema:"public",table:"staff",filter:`business_id=eq.${i}`},a=>{console.log("Staff changed:",a),_()}).subscribe(),n=()=>{_()},d=()=>{document.visibilityState==="visible"&&_()};return window.addEventListener("focus",n),document.addEventListener("visibilitychange",d),()=>{u.removeChannel(f),u.removeChannel(t),u.removeChannel(E),window.removeEventListener("focus",n),document.removeEventListener("visibilitychange",d)}},[i,_]),{establishment:q,services:b,staff:D,paymentMethods:N,loading:y,error:$,refetch:_}}export{M as a,F as u};
