import{r as o,s as u}from"./index-uyy-nLXi.js";let p=null,R=0;const N=5*60*1e3;function A(){const[a,C]=o.useState(p||[]),[E,w]=o.useState(!p),[q,D]=o.useState(null),[T,$]=o.useState(!p),f=o.useCallback(async(y=!1,m=!1)=>{const v=Date.now();if(!y&&p&&v-R<N){C(p),w(!1),$(!1);return}const b=p!==null&&p.length>0;try{(!m||!b)&&w(!0),m||D(null);const{data:i,error:l}=await u.from("businesses").select("id, business_name, description, address, phone, email, average_rating, total_reviews, logo_url, cover_image_url, primary_category, category, secondary_categories, slug, is_public, is_active, temporarily_closed, closed_until, google_maps_url, latitude, longitude, created_at").eq("is_public",!0).eq("is_active",!0).eq("approval_status","approved").order("created_at",{ascending:!1}).limit(100);if(l)throw console.error("Error fetching businesses:",l),l;const e=(i||[]).map(s=>({id:s.id,name:s.business_name||"Sin nombre",description:s.description,address:s.address,phone:s.phone,email:s.email,rating:4.5,review_count:s.total_reviews||0,main_image:s.logo_url||s.cover_image_url,logo_url:s.logo_url??null,cover_image_url:s.cover_image_url??null,category:s.primary_category||s.category,primary_category:s.primary_category,secondary_categories:s.secondary_categories||[],slug:s.slug,is_public:s.is_public??!0,is_active:s.is_active??!0,temporarily_closed:s.temporarily_closed??!1,closed_until:s.closed_until??null,google_maps_url:s.google_maps_url??null,latitude:s.latitude??null,longitude:s.longitude??null}));p=e,R=v,C(e),$(!1)}catch(i){m?console.warn("Error en refresh realtime de establishments (manteniendo datos anteriores):",i):(D(i.message),console.error("Error fetching establishments (initial load):",i))}finally{(!m||!b)&&w(!1)}},[]);return o.useEffect(()=>{f()},[f]),o.useEffect(()=>{let y=null;const m=3,v=i=>{console.log("Businesses changed via Realtime:",i);const l=async(e=0)=>{try{await f(!0,!0)}catch{if(e<m){const n=Math.min(1e3*Math.pow(2,e),1e4);console.warn(`Realtime refresh fallÃ³, reintentando en ${n}ms (intento ${e+1}/${m})`),y=setTimeout(()=>{l(e+1)},n)}else console.error("MÃ¡ximo de intentos alcanzado para refresh realtime, manteniendo datos anteriores")}};l()},b=u.channel(`public-businesses-realtime-${Date.now()}`).on("postgres_changes",{event:"*",schema:"public",table:"businesses"},v).subscribe(i=>{console.log("[Realtime] Businesses subscription status:",i)});return()=>{y&&clearTimeout(y),u.removeChannel(b)}},[f]),{establishments:a,loading:E,error:q,refetch:f}}function U(a){const[C,E]=o.useState(null),[w,q]=o.useState([]),[D,T]=o.useState([]),[$,f]=o.useState([]),[y,m]=o.useState(!0),[v,b]=o.useState(null),i=o.useCallback(async()=>{if(a)try{m(!0);const l=n=>{const g=n.price_currency||"DOP",c=Number(n.price||0);let r=0;if(n.price_usd!=null&&n.price_usd!==void 0){const d=String(n.price_usd).trim();if(d!==""&&d!=="null"&&d!=="undefined"){const _=parseFloat(d);!isNaN(_)&&isFinite(_)&&(r=_)}}let t=0,h=0;g==="USD"||g==="$"?(h=c,t=r):(t=c,h=r);const S={...n,duration:n.duration_minutes||n.duration||30,price:c,price_currency:g,currency:g};return S.price_rd=Number(t)||0,S.price_usd=Number(h)||0,S},{data:e,error:s}=await u.from("businesses").select("*").eq("id",a).maybeSingle();if(s)throw console.error("Error fetching business:",s),s;if(e){const n={id:e.id,name:e.business_name||"Sin nombre",description:e.description,address:e.address,phone:e.phone,email:e.email,rating:4.5,review_count:e.total_reviews||0,main_image:e.logo_url||e.cover_image_url,logo_url:e.logo_url??null,cover_image_url:e.cover_image_url??null,category:e.primary_category||e.category,primary_category:e.primary_category,secondary_categories:e.secondary_categories||[],slug:e.slug,is_public:e.is_public??!0,is_active:e.is_active??!0,temporarily_closed:e.temporarily_closed??!1,closed_until:e.closed_until??null,google_maps_url:e.google_maps_url??null,latitude:e.latitude??null,longitude:e.longitude??null};E(n);const[g,c,r,t]=await Promise.all([u.from("services").select("*").eq("business_id",a).eq("is_active",!0).order("display_order",{nullsFirst:!1}).order("name",{ascending:!0}),u.from("business_services").select("*").eq("business_id",a).eq("is_active",!0),u.from("staff").select("*").eq("business_id",a).eq("is_active",!0),u.from("payment_methods").select("*").eq("business_id",a).eq("is_active",!0)]);g.error&&console.error("Error fetching services:",g.error),c.error&&console.error("Error fetching business_services:",c.error);const h=new Map;(g.data||[]).forEach(d=>{const _=l(d);h.set(_.id,_)}),(c.data||[]).forEach(d=>{const _=l({...d,duration_minutes:d.duration_minutes||30});h.has(_.id)||h.set(_.id,_)});const S=Array.from(h.values()).sort((d,_)=>{const M=d.display_order??999,L=_.display_order??999;return M!==L?M-L:(d.name||"").localeCompare(_.name||"")});q(S),T(r.data||[]),f(t.data||[])}else b("Establecimiento no encontrado")}catch(l){b(l.message),console.error("Error fetching establishment:",l)}finally{m(!1)}},[a]);return o.useEffect(()=>{if(!a){E(null),q([]),T([]),f([]),m(!1);return}i();const l=u.channel(`business-${a}-${Date.now()}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"businesses",filter:`id=eq.${a}`},c=>{console.log("ðŸ”„ Business data changed via Realtime:",c);const r=c.new;r&&E(t=>t&&{...t,name:r.business_name||t.name,description:r.description??t.description,address:r.address??t.address,phone:r.phone??t.phone,email:r.email??t.email,rating:Number(r.average_rating)||t.rating,review_count:r.total_reviews??t.review_count,main_image:r.logo_url||r.cover_image_url||t.main_image,logo_url:r.logo_url??t.logo_url,cover_image_url:r.cover_image_url??t.cover_image_url,category:r.primary_category||r.category||t.category,primary_category:r.primary_category??t.primary_category,secondary_categories:r.secondary_categories??t.secondary_categories,is_active:r.is_active??t.is_active,is_public:r.is_public??t.is_public,temporarily_closed:r.temporarily_closed??!1,closed_until:r.closed_until??null,latitude:r.latitude??t.latitude,longitude:r.longitude??t.longitude}),i()}).subscribe(),e=u.channel(`services-${a}`).on("postgres_changes",{event:"*",schema:"public",table:"services",filter:`business_id=eq.${a}`},c=>{console.log("Services changed:",c),i()}).subscribe(),s=u.channel(`staff-${a}`).on("postgres_changes",{event:"*",schema:"public",table:"staff",filter:`business_id=eq.${a}`},c=>{console.log("Staff changed:",c),i()}).subscribe(),n=()=>{i()},g=()=>{document.visibilityState==="visible"&&i()};return window.addEventListener("focus",n),document.addEventListener("visibilitychange",g),()=>{u.removeChannel(l),u.removeChannel(e),u.removeChannel(s),window.removeEventListener("focus",n),document.removeEventListener("visibilitychange",g)}},[a,i]),{establishment:C,services:w,staff:D,paymentMethods:$,loading:y,error:v,refetch:i}}export{A as a,U as u};
