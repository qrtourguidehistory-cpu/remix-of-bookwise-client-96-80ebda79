import{a as re,r as _,s as l,J as P}from"./index-BrdmEQqy.js";const U=r=>/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(r),te=(r,i)=>{const[h,D]=r.split(":").map(Number),A=h*60+D+i,C=Math.floor(A/60)%24,N=A%60;return`${C.toString().padStart(2,"0")}:${N.toString().padStart(2,"0")}`};function ie(){const{user:r,profile:i}=re(),[h,D]=_.useState([]),[A,C]=_.useState(!0),[N,J]=_.useState(null),[V,k]=_.useState(!1),w=_.useCallback(async()=>{try{C(!0);let e=l.from("appointments").select(`
          *,
          businesses:business_id (id, business_name, logo_url, cover_image_url, address),
          staff:staff_id (id, full_name),
          appointment_services (
            service_id,
            price,
            services:service_id (
              id,
              name,
              duration_minutes,
              price,
              price_currency,
              price_usd
            )
          ),
          services:service_id (
            id,
            price,
            price_currency,
            price_usd
          )
        `);r!=null&&r.id?e=e.eq("user_id",r.id):i!=null&&i.email&&(e=e.eq("client_email",i.email));const{data:t,error:n}=await e.order("date",{ascending:!1}).order("start_time",{ascending:!1});if(n)throw console.error("Error fetching appointments:",n),n;const u=new Set;(t||[]).filter(o=>o.user_id&&o.business_id).forEach(o=>{const m=`${o.user_id}::${o.business_id}`;u.add(m)});const g={};if(u.size>0){const o=Array.from(u).map(async a=>{const[f,c]=a.split("::"),{data:p,error:v}=await l.from("clients").select("id, user_id, business_id, first_name, last_name, full_name, email").eq("user_id",f).eq("business_id",c).maybeSingle();return!v&&p?{key:a,data:p}:null});(await Promise.all(o)).forEach(a=>{a&&(g[a.key]=a.data)})}const E=(t||[]).map(o=>{const m=o.businesses,a=m?{id:m.id,name:m.business_name||"Sin nombre",main_image:m.logo_url||m.cover_image_url,address:m.address}:null,f=(o.appointment_services||[]).map(y=>{const d=y.services;if(!d||!d.id)return{id:y.service_id||"",name:"Servicio",price:0,price_rd:0,price_usd:0,duration_minutes:0,currency:"DOP"};const T=d.price_currency||"DOP",x=R=>{if(R==null||R===void 0)return 0;if(typeof R=="number")return isNaN(R)?0:R;if(typeof R=="string"){const q=R.trim();if(q===""||q==="null"||q==="undefined")return 0;const L=parseFloat(q);return isNaN(L)?0:L}return 0},H=x(d.price),z=x(d.price_usd),ee=x(d.duration_minutes);let M=0,O=0;return T==="USD"||T==="$"?(O=H,M=z):(M=H,O=z),{id:d.id||y.service_id||"",name:d.name||"Servicio",price:H,price_rd:M,price_usd:O,duration_minutes:ee,currency:T}}),c=f.reduce((y,d)=>y+(Number(d.price_rd)||0),0),p=f.reduce((y,d)=>y+(Number(d.price_usd)||0),0),v=f.length>0?f[0].currency:"RD$";let S=null;if(o.user_id&&o.business_id){const y=`${o.user_id}::${o.business_id}`,d=g[y];d&&(S={first_name:d.first_name||null,last_name:d.last_name||null,full_name:d.full_name||null,email:d.email||null})}const $=S;return{...o,establishment:a,staff:o.staff,clients:$,services:f.length>0?f:void 0,price_currency:v,price_rd:c,price_usd:p}});D(E)}catch(e){J(e.message),console.error("Error fetching appointments:",e)}finally{C(!1)}},[r==null?void 0:r.id,i==null?void 0:i.email]),W=async e=>{var t;try{let n=e.establishment_id;if(console.log("Creating appointment with business_id:",n),!U(n))throw new Error("Invalid business ID provided");const{data:u}=await l.from("businesses").select("id").eq("id",n).maybeSingle();if(!u)throw new Error("Business not found");console.log("Business verified:",n);let s=null;if(r!=null&&r.id){const{data:c,error:p}=await l.from("clients").select("id, full_name, email, phone").eq("user_id",r.id).eq("business_id",n).maybeSingle();if(p&&p.code!=="PGRST116"&&console.error("Error searching for client:",p),c!=null&&c.id)s=c.id,console.log("Found existing client:",s);else{const v={user_id:r.id,business_id:n,full_name:(i==null?void 0:i.full_name)||null,first_name:null,last_name:null,email:(i==null?void 0:i.email)||null,phone:(i==null?void 0:i.phone)||null,is_active:!0,is_blocked:!1},{data:S,error:$}=await l.from("clients").insert(v).select("id").single();$?(console.error("Error creating client:",$),console.warn("Could not create client record, proceeding without client_id")):(s=S.id,console.log("Created new client:",s))}}const g=te(e.start_time,e.duration_minutes);let E=e.staff_id||null;E&&!U(E)&&(E=null);const o=((t=e.services.find(c=>U(c.id)))==null?void 0:t.id)||null,m={user_id:(r==null?void 0:r.id)||null,client_id:s,staff_id:E,service_id:o,client_name:e.client_name||null,client_email:e.client_email||null,client_phone:e.client_phone||null,date:e.date,start_time:e.start_time,end_time:g,notes:e.notes||null,price:e.price,duration_minutes:e.duration_minutes,status:"pending"};m.business_id=n,console.log("Saving appointment with business_id:",n),console.log("Saving appointment with client_id:",s),console.log("Saving appointment with client_name:",e.client_name),console.log("Saving appointment with user_id:",r==null?void 0:r.id),console.log("Insert data:",JSON.stringify(m,null,2));const{data:a,error:f}=await l.from("appointments").insert(m).select().single();if(f)throw console.error("Error inserting appointment:",f),f;if(console.log("Appointment created successfully:",a),a!=null&&a.id){console.log("PUSH::START::create",{appointment_id:a.id});try{const{data:c,error:p}=await l.functions.invoke("notify-new-appointment",{body:{appointment_id:a.id}});p?console.log("PUSH::ERROR::create",{appointment_id:a.id,error:p}):console.log("PUSH::SUCCESS::create",{appointment_id:a.id,response:c})}catch(c){console.log("PUSH::ERROR::create",{appointment_id:a.id,error:c})}}if(e.services.length>0&&a){const c=e.services.filter(p=>U(p.id));if(c.length>0){const p=c.map(S=>({appointment_id:a.id,service_id:S.id,price:S.price})),{error:v}=await l.from("appointment_services").insert(p);v?(console.error("Error inserting services:",v),console.warn("Services were not saved to appointment_services, but appointment was created with service_id:",o)):console.log("Successfully saved",c.length,"service(s) to appointment_services")}}return await w(),{data:a,error:null}}catch(n){return console.error("Error creating appointment:",n),{data:null,error:n.message}}},F=_.useCallback(async()=>{if(r!=null&&r.id)try{const{data:e,error:t}=await l.from("appointments").select("id, date, start_time, status, created_at").eq("user_id",r.id).in("status",["completed","cancelled"]).order("date",{ascending:!1}).order("start_time",{ascending:!1});if(t){console.error("Error fetching history for cleanup:",t);return}const n=(e==null?void 0:e.length)||0;if(n>=15){if(k(!0),n===15){const u=e.filter(s=>s.status==="completed").slice(15);if(u.length>0){const s=u.map(E=>E.id),{error:g}=await l.from("appointments").delete().in("id",s);g?console.error("Error auto-deleting old appointments:",g):(console.log(`ðŸ§¹ Auto-deleted ${s.length} old completed appointments`),w())}}}else k(!1)}catch(e){console.error("Error cleaning up old appointments:",e)}},[r==null?void 0:r.id]);_.useEffect(()=>{h.length>0&&F()},[h.length,F]);const G=async e=>{try{console.log("Cancelling appointment:",e);const{data:t,error:n}=await l.from("appointments").select("id, status").eq("id",e).maybeSingle();if(n)throw console.error("Error fetching appointment:",n),new Error(`Error al buscar la cita: ${n.message}`);if(!t)throw new Error("La cita no existe en el sistema");console.log("Found appointment:",t);const{error:u}=await l.from("appointments").update({status:"cancelled"}).eq("id",e);if(u)throw console.error("Supabase update error:",u),new Error(`Error al actualizar: ${u.message}`);console.log("Appointment cancelled successfully"),console.log("PUSH::START::cancel",{appointment_id:e});try{const{data:s,error:g}=await l.functions.invoke("notify-appointment-cancelled",{body:{appointment_id:e}});g?console.log("PUSH::ERROR::cancel",{appointment_id:e,error:g}):console.log("PUSH::SUCCESS::cancel",{appointment_id:e,response:s})}catch(s){console.log("PUSH::ERROR::cancel",{appointment_id:e,error:s})}return P({title:"Cita cancelada",description:"Tu cita ha sido cancelada exitosamente."}),await w(),{success:!0}}catch(t){return console.error("Error cancelling appointment:",t),P({title:"Error",description:`No se pudo cancelar la cita: ${t.message}`,variant:"destructive"}),{success:!1,error:t.message}}},I=async(e,t)=>{try{const{error:n}=await l.from("appointments").update(t).eq("id",e);if(n)throw n;return await w(),{success:!0}}catch(n){return{success:!1,error:n.message}}},K=async e=>{try{const{error:t}=await l.from("appointments").update({early_confirmed:!0}).eq("id",e);if(t)throw t;return await w(),{success:!0}}catch(t){return console.error("Error confirming early arrival:",t),{success:!1,error:t.message}}},j=async e=>{try{console.log("Deleting appointment:",e);const{data:t,error:n}=await l.from("appointments").select("id, user_id, client_email").eq("id",e).maybeSingle();if(n)throw console.error("Error fetching appointment:",n),new Error(`Error al buscar la cita: ${n.message}`);if(!t)throw new Error("La cita no existe en el sistema");if(r!=null&&r.id&&t.user_id!==r.id)throw new Error("No tienes permiso para eliminar esta cita");if(!(r!=null&&r.id)&&(i!=null&&i.email)&&t.client_email!==i.email)throw new Error("No tienes permiso para eliminar esta cita");const{error:u}=await l.from("appointment_services").delete().eq("appointment_id",e);u&&console.warn("Error deleting appointment services (may not exist):",u);const{error:s}=await l.from("appointments").delete().eq("id",e);if(s)throw console.error("Supabase delete error:",s),new Error(`Error al eliminar: ${s.message}`);return console.log("Appointment deleted successfully"),P({title:"Cita eliminada",description:"La cita ha sido eliminada de tu historial exitosamente."}),await w(),{success:!0}}catch(t){return console.error("Error deleting appointment:",t),P({title:"Error",description:`No se pudo eliminar la cita: ${t.message}`,variant:"destructive"}),{success:!1,error:t.message}}},b=_.useRef(null),Q=_.useRef(`appointments-${Date.now()}-${Math.random().toString(36).substring(7)}`);_.useEffect(()=>{w(),b.current&&(l.removeChannel(b.current),b.current=null);const e=`appointments-${(r==null?void 0:r.id)||"anon"}-${Date.now()}`;Q.current=e;const t=l.channel(e).on("postgres_changes",{event:"*",schema:"public",table:"appointments"},n=>{console.log("Appointment changed:",n),w()}).subscribe();return b.current=t,()=>{b.current&&(l.removeChannel(b.current),b.current=null)}},[r==null?void 0:r.id,i==null?void 0:i.email,w]);const B=(e,t)=>{if(!e)return!1;const u=new Date().getTime(),[s,g,E]=e.split("-").map(Number);let o=0,m=0;if(t){const c=t.split(":").map(Number);o=c[0]||0,m=c[1]||0}return new Date(s,g-1,E,o,m,0,0).getTime()>u},X=_.useMemo(()=>h.filter(e=>(e.status==="confirmed"||e.status==="pending")&&B(e.date,e.start_time)),[h]),Y=_.useMemo(()=>h.filter(e=>!!(e.status==="completed"||e.status==="cancelled"||e.status!=="completed"&&e.date&&!B(e.date,e.start_time))),[h]),Z=_.useMemo(()=>h.filter(e=>e.status==="cancelled"),[h]);return{appointments:h,upcomingAppointments:X,pastAppointments:Y,cancelledAppointments:Z,loading:A,error:N,historyFull:V,createAppointment:W,cancelAppointment:G,updateAppointment:I,deleteAppointment:j,confirmEarlyArrival:K,refetch:w}}export{ie as u};
