import{r as c,x as u}from"./index-BMtVW8Qo.js";let w=null,P=0;const U=5*60*1e3;function F(){const[i,q]=c.useState(w||[]),[p,b]=c.useState(!w),[C,D]=c.useState(null),y=c.useCallback(async($=!1)=>{const v=Date.now();if(!$&&w&&v-P<U){q(w),b(!1);return}try{b(!0),D(null);const{data:h,error:g}=await u.from("businesses").select("id, business_name, description, address, phone, email, average_rating, total_reviews, logo_url, cover_image_url, primary_category, category, secondary_categories, slug, is_public, is_active, temporarily_closed, closed_until, created_at").eq("is_public",!0).eq("is_active",!0).order("created_at",{ascending:!1}).limit(100);if(g)throw console.error("Error fetching businesses:",g),g;const N=(h||[]).map(s=>({id:s.id,name:s.business_name||"Sin nombre",description:s.description,address:s.address,phone:s.phone,email:s.email,rating:Number(s.average_rating)||0,review_count:s.total_reviews||0,main_image:s.logo_url||s.cover_image_url,category:s.primary_category||s.category,primary_category:s.primary_category,secondary_categories:s.secondary_categories||[],slug:s.slug,is_public:s.is_public??!0,is_active:s.is_active??!0,temporarily_closed:s.temporarily_closed??!1,closed_until:s.closed_until??null}));w=N,P=v,q(N)}catch(h){D(h.message),console.error("Error fetching establishments:",h)}finally{b(!1)}},[]);return c.useEffect(()=>{y()},[y]),{establishments:i,loading:p,error:C,refetch:y}}function M(i){const[q,p]=c.useState(null),[b,C]=c.useState([]),[D,y]=c.useState([]),[$,v]=c.useState([]),[h,g]=c.useState(!0),[N,s]=c.useState(null),_=c.useCallback(async()=>{if(i)try{g(!0);const f=n=>{const m=n.price_currency||"DOP",a=Number(n.price||0);let e=0;if(n.price_usd!=null&&n.price_usd!==void 0){const l=String(n.price_usd).trim();if(l!==""&&l!=="null"&&l!=="undefined"){const o=parseFloat(l);!isNaN(o)&&isFinite(o)&&(e=o)}}let t=0,d=0;m==="USD"||m==="$"?(d=a,t=e):(t=a,d=e);const S={...n,duration:n.duration_minutes||n.duration||30,price:a,price_currency:m,currency:m};return S.price_rd=Number(t)||0,S.price_usd=Number(d)||0,S},{data:r,error:E}=await u.from("businesses").select("*").eq("id",i).maybeSingle();if(E)throw console.error("Error fetching business:",E),E;if(r){const n={id:r.id,name:r.business_name||"Sin nombre",description:r.description,address:r.address,phone:r.phone,email:r.email,rating:Number(r.average_rating)||0,review_count:r.total_reviews||0,main_image:r.logo_url||r.cover_image_url,category:r.primary_category||r.category,primary_category:r.primary_category,secondary_categories:r.secondary_categories||[],slug:r.slug,is_public:r.is_public??!0,is_active:r.is_active??!0,temporarily_closed:r.temporarily_closed??!1,closed_until:r.closed_until??null};p(n);const[m,a,e,t]=await Promise.all([u.from("services").select("*").eq("business_id",i).eq("is_active",!0).order("display_order",{nullsFirst:!1}).order("name",{ascending:!0}),u.from("business_services").select("*").eq("business_id",i).eq("is_active",!0),u.from("staff").select("*").eq("business_id",i).eq("is_active",!0),u.from("payment_methods").select("*").eq("business_id",i).eq("is_active",!0)]);m.error&&console.error("Error fetching services:",m.error),a.error&&console.error("Error fetching business_services:",a.error);const d=new Map;(m.data||[]).forEach(l=>{const o=f(l);d.set(o.id,o)}),(a.data||[]).forEach(l=>{const o=f({...l,duration_minutes:l.duration_minutes||30});d.has(o.id)||d.set(o.id,o)});const S=Array.from(d.values()).sort((l,o)=>{const R=l.display_order??999,L=o.display_order??999;return R!==L?R-L:(l.name||"").localeCompare(o.name||"")});C(S),y(e.data||[]),v(t.data||[])}else s("Establecimiento no encontrado")}catch(f){s(f.message),console.error("Error fetching establishment:",f)}finally{g(!1)}},[i]);return c.useEffect(()=>{if(!i){p(null),C([]),y([]),v([]),g(!1);return}_();const f=u.channel(`business-${i}-${Date.now()}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"businesses",filter:`id=eq.${i}`},a=>{console.log("ðŸ”„ Business data changed via Realtime:",a);const e=a.new;e&&p(t=>t&&{...t,name:e.business_name||t.name,description:e.description??t.description,address:e.address??t.address,phone:e.phone??t.phone,email:e.email??t.email,rating:Number(e.average_rating)||t.rating,review_count:e.total_reviews??t.review_count,main_image:e.logo_url||e.cover_image_url||t.main_image,category:e.primary_category||e.category||t.category,primary_category:e.primary_category??t.primary_category,secondary_categories:e.secondary_categories??t.secondary_categories,is_active:e.is_active??t.is_active,is_public:e.is_public??t.is_public,temporarily_closed:e.temporarily_closed??!1,closed_until:e.closed_until??null}),_()}).subscribe(),r=u.channel(`services-${i}`).on("postgres_changes",{event:"*",schema:"public",table:"services",filter:`business_id=eq.${i}`},a=>{console.log("Services changed:",a),_()}).subscribe(),E=u.channel(`staff-${i}`).on("postgres_changes",{event:"*",schema:"public",table:"staff",filter:`business_id=eq.${i}`},a=>{console.log("Staff changed:",a),_()}).subscribe(),n=()=>{_()},m=()=>{document.visibilityState==="visible"&&_()};return window.addEventListener("focus",n),document.addEventListener("visibilitychange",m),()=>{u.removeChannel(f),u.removeChannel(r),u.removeChannel(E),window.removeEventListener("focus",n),document.removeEventListener("visibilitychange",m)}},[i,_]),{establishment:q,services:b,staff:D,paymentMethods:$,loading:h,error:N,refetch:_}}export{M as a,F as u};
