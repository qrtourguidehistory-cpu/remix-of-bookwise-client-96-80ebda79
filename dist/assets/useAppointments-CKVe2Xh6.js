import{a as j,r as m,x as c,Q as N}from"./index-CnnmV7T0.js";const $=n=>/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(n),G=(n,s)=>{const[p,q]=n.split(":").map(Number),b=p*60+q+s,S=Math.floor(b/60)%24,x=b%60;return`${S.toString().padStart(2,"0")}:${x.toString().padStart(2,"0")}`};function W(){const{user:n,profile:s}=j(),[p,q]=m.useState([]),[b,S]=m.useState(!0),[x,I]=m.useState(null),f=m.useCallback(async()=>{try{S(!0);let e=c.from("appointments").select(`
          *,
          businesses:business_id (id, business_name, logo_url, cover_image_url, address),
          staff:staff_id (id, full_name),
          appointment_services (
            service_id,
            price,
            services:service_id (
              id,
              name,
              duration_minutes,
              price,
              price_currency,
              price_usd
            )
          ),
          services:service_id (
            id,
            price,
            price_currency,
            price_usd
          )
        `);n!=null&&n.id?e=e.eq("user_id",n.id):s!=null&&s.email&&(e=e.eq("client_email",s.email));const{data:r,error:t}=await e.order("date",{ascending:!1}).order("start_time",{ascending:!1});if(t)throw console.error("Error fetching appointments:",t),t;const u=(r||[]).map(d=>{const a=d.businesses,v=a?{id:a.id,name:a.business_name||"Sin nombre",main_image:a.logo_url||a.cover_image_url,address:a.address}:null,l=(d.appointment_services||[]).map(o=>{const i=o.services;if(!i||!i.id)return{id:o.service_id||"",name:"Servicio",price:0,price_rd:0,price_usd:0,duration_minutes:0,currency:"DOP"};const E=i.price_currency||"DOP",C=w=>{if(w==null||w===void 0)return 0;if(typeof w=="number")return isNaN(w)?0:w;if(typeof w=="string"){const A=w.trim();if(A===""||A==="null"||A==="undefined")return 0;const U=parseFloat(A);return isNaN(U)?0:U}return 0},D=C(i.price),P=C(i.price_usd),Q=C(i.duration_minutes);let R=0,M=0;return E==="USD"||E==="$"?(M=D,R=P):(R=D,M=P),{id:i.id||o.service_id||"",name:i.name||"Servicio",price:D,price_rd:R,price_usd:M,duration_minutes:Q,currency:E}}),_=l.reduce((o,i)=>o+(Number(i.price_rd)||0),0),y=l.reduce((o,i)=>o+(Number(i.price_usd)||0),0),g=l.length>0?l[0].currency:"RD$";return{...d,establishment:v,staff:d.staff,services:l.length>0?l:void 0,price_currency:g,price_rd:_,price_usd:y}});q(u)}catch(e){I(e.message),console.error("Error fetching appointments:",e)}finally{S(!1)}},[n==null?void 0:n.id,s==null?void 0:s.email]),L=async e=>{var r;try{let t=e.establishment_id;if(console.log("Creating appointment with business_id:",t),!$(t))throw new Error("Invalid business ID provided");const{data:u}=await c.from("businesses").select("id").eq("id",t).maybeSingle();if(!u)throw new Error("Business not found");console.log("Business verified:",t);const d=G(e.start_time,e.duration_minutes);let a=e.staff_id||null;a&&!$(a)&&(a=null);const v=((r=e.services.find(g=>$(g.id)))==null?void 0:r.id)||null,l={user_id:(n==null?void 0:n.id)||null,staff_id:a,service_id:v,client_name:e.client_name,client_email:e.client_email||null,client_phone:e.client_phone||null,date:e.date,start_time:e.start_time,end_time:d,notes:e.notes||null,price:e.price,duration_minutes:e.duration_minutes,status:"pending"};l.business_id=t,console.log("Saving appointment with business_id:",t),console.log("Insert data:",JSON.stringify(l,null,2));const{data:_,error:y}=await c.from("appointments").insert(l).select().single();if(y)throw console.error("Error inserting appointment:",y),y;if(console.log("Appointment created successfully:",_),e.services.length>0&&_){const g=e.services.filter(o=>$(o.id));if(g.length>0){const o=g.map(E=>({appointment_id:_.id,service_id:E.id,price:E.price})),{error:i}=await c.from("appointment_services").insert(o);i?(console.error("Error inserting services:",i),console.warn("Services were not saved to appointment_services, but appointment was created with service_id:",v)):console.log("Successfully saved",g.length,"service(s) to appointment_services")}}return await f(),{data:_,error:null}}catch(t){return console.error("Error creating appointment:",t),{data:null,error:t.message}}},z=async e=>{try{console.log("Cancelling appointment:",e);const{data:r,error:t}=await c.from("appointments").select("id, status").eq("id",e).maybeSingle();if(t)throw console.error("Error fetching appointment:",t),new Error(`Error al buscar la cita: ${t.message}`);if(!r)throw new Error("La cita no existe en el sistema");console.log("Found appointment:",r);const{error:u}=await c.from("appointments").update({status:"cancelled"}).eq("id",e);if(u)throw console.error("Supabase update error:",u),new Error(`Error al actualizar: ${u.message}`);return console.log("Appointment cancelled successfully"),N({title:"Cita cancelada",description:"Tu cita ha sido cancelada exitosamente."}),await f(),{success:!0}}catch(r){return console.error("Error cancelling appointment:",r),N({title:"Error",description:`No se pudo cancelar la cita: ${r.message}`,variant:"destructive"}),{success:!1,error:r.message}}},B=async(e,r)=>{try{const{error:t}=await c.from("appointments").update(r).eq("id",e);if(t)throw t;return await f(),{success:!0}}catch(t){return{success:!1,error:t.message}}},F=async e=>{try{const{error:r}=await c.from("appointments").update({early_confirmed:!0}).eq("id",e);if(r)throw r;return await f(),{success:!0}}catch(r){return console.error("Error confirming early arrival:",r),{success:!1,error:r.message}}},O=async e=>{try{console.log("Deleting appointment:",e);const{data:r,error:t}=await c.from("appointments").select("id, user_id, client_email").eq("id",e).maybeSingle();if(t)throw console.error("Error fetching appointment:",t),new Error(`Error al buscar la cita: ${t.message}`);if(!r)throw new Error("La cita no existe en el sistema");if(n!=null&&n.id&&r.user_id!==n.id)throw new Error("No tienes permiso para eliminar esta cita");if(!(n!=null&&n.id)&&(s!=null&&s.email)&&r.client_email!==s.email)throw new Error("No tienes permiso para eliminar esta cita");const{error:u}=await c.from("appointment_services").delete().eq("appointment_id",e);u&&console.warn("Error deleting appointment services (may not exist):",u);const{error:d}=await c.from("appointments").delete().eq("id",e);if(d)throw console.error("Supabase delete error:",d),new Error(`Error al eliminar: ${d.message}`);return console.log("Appointment deleted successfully"),N({title:"Cita eliminada",description:"La cita ha sido eliminada de tu historial exitosamente."}),await f(),{success:!0}}catch(r){return console.error("Error deleting appointment:",r),N({title:"Error",description:`No se pudo eliminar la cita: ${r.message}`,variant:"destructive"}),{success:!1,error:r.message}}},h=m.useRef(null),V=m.useRef(`appointments-${Date.now()}-${Math.random().toString(36).substring(7)}`);m.useEffect(()=>{f(),h.current&&(c.removeChannel(h.current),h.current=null);const e=`appointments-${(n==null?void 0:n.id)||"anon"}-${Date.now()}`;V.current=e;const r=c.channel(e).on("postgres_changes",{event:"*",schema:"public",table:"appointments"},t=>{console.log("Appointment changed:",t),f()}).subscribe();return h.current=r,()=>{h.current&&(c.removeChannel(h.current),h.current=null)}},[n==null?void 0:n.id,s==null?void 0:s.email,f]);const T=(e,r)=>{if(!e)return!1;const u=new Date().getTime(),[d,a,v]=e.split("-").map(Number);let l=0,_=0;if(r){const o=r.split(":").map(Number);l=o[0]||0,_=o[1]||0}return new Date(d,a-1,v,l,_,0,0).getTime()>u},k=m.useMemo(()=>p.filter(e=>(e.status==="confirmed"||e.status==="pending")&&T(e.date,e.start_time)),[p]),H=m.useMemo(()=>p.filter(e=>!!(e.status==="completed"||e.status==="cancelled"||e.status!=="completed"&&e.date&&!T(e.date,e.start_time))),[p]),J=m.useMemo(()=>p.filter(e=>e.status==="cancelled"),[p]);return{appointments:p,upcomingAppointments:k,pastAppointments:H,cancelledAppointments:J,loading:b,error:x,createAppointment:L,cancelAppointment:z,updateAppointment:B,deleteAppointment:O,confirmEarlyArrival:F,refetch:f}}export{W as u};
