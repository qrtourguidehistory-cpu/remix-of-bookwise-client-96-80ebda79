import{S as J,u as K,b as O,a as V,M as W,r as n,j as e,N as h,B as l,x as v,Q as u}from"./index-CzloO7cy.js";import{T as X}from"./textarea-tQFTGTVp.js";import{S as Z}from"./settings-CTgYEvlp.js";import{S as j}from"./star-CruCOwsY.js";import{T as ee}from"./tag-DQ7nrXy1.js";import{C as se}from"./calendar-Dtgz1bCW.js";import{A as te}from"./arrow-left-DZEGrZ4W.js";const q={appointment:se,promotion:ee,review:j,system:Z},me=()=>{const{id:E}=J(),x=K(),{t}=O(),{user:a}=V(),{notifications:F,markAsRead:R,loading:L,error:Y}=W(),s=E?F.find(i=>i.id===E):void 0,[o,y]=n.useState(0),[d,_]=n.useState(""),[p,P]=n.useState(!1),[k,$]=n.useState(null),[D,z]=n.useState(null),[b,I]=n.useState(null),[M,S]=n.useState(!1),[w,N]=n.useState(!1);n.useEffect(()=>{(async()=>{var f,T,B;if(console.log("NotificationDetailPage - Checking notification:",{type:s==null?void 0:s.type,appointment_id:s==null?void 0:s.appointment_id,hasUser:!!a,notification:s}),((s==null?void 0:s.type)==="review"||((f=s==null?void 0:s.meta)==null?void 0:f.type)==="review_request")&&s.appointment_id&&a){console.log("NotificationDetailPage - Fetching business info for review notification"),S(!0);try{const{data:r,error:C}=await v.from("appointments").select(`
              business_id,
              businesses:business_id (id, business_name)
            `).eq("id",s.appointment_id).single();if(console.log("NotificationDetailPage - Appointment data:",r,"Error:",C),C)throw C;if(r!=null&&r.business_id){console.log("NotificationDetailPage - Setting business info:",{business_id:r.business_id,business_name:(T=r.businesses)==null?void 0:T.business_name}),$(r.business_id),z(((B=r.businesses)==null?void 0:B.business_name)||null);const{data:m,error:H}=await v.from("reviews").select("id, status, rating, comment").eq("appointment_id",s.appointment_id).eq("user_id",a.id).order("updated_at",{ascending:!1});console.log("NotificationDetailPage - Existing reviews check:",{existingReviews:m,error:H,appointment_id:s.appointment_id,user_id:a.id});const c=(m==null?void 0:m.find(g=>g.status==="completed"))||(m==null?void 0:m[0]);if(c)if(I(c.id),c.status==="completed"){console.log("NotificationDetailPage - Review already completed, showing read-only view"),y(c.rating||0),_(c.comment||""),N(!0),S(!1);return}else c.rating&&y(c.rating),c.comment&&_(c.comment),N(!1);else{console.log("NotificationDetailPage - Creating new review");const{data:g,error:A}=await v.from("reviews").insert({business_id:r.business_id,user_id:a.id,appointment_id:s.appointment_id||null,status:"pending"}).select().single();console.log("NotificationDetailPage - New review created:",g,"Error:",A),!A&&g&&I(g.id)}}else console.log("NotificationDetailPage - No business_id found in appointment")}catch(r){console.error("NotificationDetailPage - Error fetching business info:",r)}finally{S(!1)}}else console.log("NotificationDetailPage - Conditions not met:",{isReview:(s==null?void 0:s.type)==="review",hasAppointmentId:!!(s!=null&&s.appointment_id),hasUser:!!a})})()},[s,a]),n.useEffect(()=>{s&&!s.read&&R(s.id)},[s,R]);const U=async()=>{if(console.log("handleSubmitReview - Starting with:",{reviewCompleted:w,reviewId:b,rating:o,comment:d}),w){u({title:t("common.error"),description:"Ya has completado esta reseña",variant:"destructive"});return}if(o===0){u({title:t("common.error"),description:t("reviews.selectRating")||"Por favor selecciona una calificación",variant:"destructive"});return}if(!b){if(console.error("No reviewId available - creating new review"),!k||!a){u({title:t("common.error"),description:"No se pudo identificar el establecimiento",variant:"destructive"});return}try{const{data:i,error:f}=await v.from("reviews").insert({business_id:k,user_id:a.id,appointment_id:(s==null?void 0:s.appointment_id)||null,rating:o,comment:d||null,status:"completed",notification_sent:!0}).select().single();if(f)throw f;console.log("Review created directly:",i),N(!0),u({title:t("common.success"),description:t("reviews.thankYou")}),setTimeout(()=>x("/"),1500);return}catch(i){console.error("Error creating review:",i),u({title:t("common.error"),description:"No se pudo enviar la reseña",variant:"destructive"});return}}P(!0);try{const{error:i}=await v.from("reviews").update({rating:o,comment:d||null,status:"completed",notification_sent:!0}).eq("id",b);if(i)throw i;N(!0),console.log("Review submitted successfully, trigger should create notification for business owner"),u({title:t("common.success"),description:t("reviews.thankYou")}),setTimeout(()=>{x("/")},1500)}catch(i){console.error("Error submitting review:",i),u({title:t("common.error"),description:t("reviews.submitError"),variant:"destructive"})}finally{P(!1)}};if(Y)return e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-muted-foreground mb-4",children:"Error al cargar notificaciones"}),e.jsx(h,{to:"/",children:e.jsx(l,{variant:"coral",children:t("common.back")})})]})});if(L)return e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsx("div",{className:"text-center",children:e.jsx("p",{className:"text-muted-foreground mb-4",children:t("common.loading")||"Cargando..."})})});if(!s)return e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-muted-foreground mb-4",children:"Notificación no encontrada"}),e.jsx(h,{to:"/",children:e.jsx(l,{variant:"coral",children:t("common.back")})})]})});const Q=s.type in q?s.type:"system",G=q[Q];return e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("header",{className:"sticky top-0 z-40 bg-card/80 backdrop-blur-md border-b border-border",children:e.jsxs("div",{className:"flex items-center h-14 px-4 max-w-lg mx-auto",children:[e.jsx(l,{variant:"ghost",size:"icon",onClick:()=>x("/"),children:e.jsx(te,{className:"w-5 h-5"})}),e.jsx("h1",{className:"flex-1 text-center font-semibold text-foreground",children:t("notifications.title")}),e.jsx("div",{className:"w-10"})]})}),e.jsx("main",{className:"max-w-lg mx-auto px-4 py-6",children:e.jsxs("div",{className:"bg-card rounded-2xl border border-border p-6 shadow-card",children:[e.jsxs("div",{className:"flex items-start gap-4 mb-6",children:[e.jsx("div",{className:`w-12 h-12 rounded-full flex items-center justify-center shrink-0 ${s.type==="appointment"?"bg-info/10 text-info":s.type==="promotion"?"bg-coral-light text-coral":s.type==="review"?"bg-warning/10 text-warning":"bg-muted text-muted-foreground"}`,children:e.jsx(G,{className:"w-6 h-6"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h2",{className:"text-lg font-semibold text-foreground mb-1",children:s.title}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.time})]})]}),e.jsx("div",{className:"border-t border-border pt-6",children:e.jsx("p",{className:"text-foreground leading-relaxed",children:s.message})}),s.type==="appointment"&&s.appointment_id&&e.jsx("div",{className:"mt-6 pt-6 border-t border-border",children:e.jsx(h,{to:"/appointments",children:e.jsx(l,{variant:"coral",className:"w-full",children:t("appointments.viewDetails")})})}),s.type==="review"&&e.jsx("div",{className:"mt-6 pt-6 border-t border-border space-y-4",children:M?e.jsx("div",{className:"text-center py-4",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:t("common.loading")||"Cargando..."})}):k?e.jsxs(e.Fragment,{children:[D&&e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:t("reviews.establishment")}),e.jsx("p",{className:"font-medium text-foreground",children:D})]}),(console.log("Review form render - reviewCompleted:",w,"reviewId:",b,"rating:",o),null),w?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-primary/5 border border-primary/20 rounded-lg p-4 text-center",children:[e.jsx(j,{className:"w-12 h-12 text-warning fill-warning mx-auto mb-2"}),e.jsx("p",{className:"font-semibold text-foreground mb-1",children:t("reviews.reviewSubmitted")||"¡Reseña enviada!"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:"Ya has enviado tu reseña para este establecimiento."}),o>0&&e.jsx("div",{className:"flex gap-1 justify-center mb-2",children:[1,2,3,4,5].map(i=>e.jsx(j,{className:`w-6 h-6 ${i<=o?"text-warning fill-warning":"text-muted-foreground"}`},i))}),d&&e.jsxs("div",{className:"mt-3 text-left",children:[e.jsx("p",{className:"text-sm font-medium text-foreground mb-1",children:"Tu comentario:"}),e.jsx("p",{className:"text-sm text-muted-foreground bg-muted/50 rounded p-3",children:d})]})]}),e.jsx(l,{variant:"outline",className:"w-full",onClick:()=>x("/"),children:t("common.back")})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-foreground mb-3",children:t("reviews.yourExperience")||"¿Cómo fue tu experiencia?"}),e.jsx("div",{className:"flex gap-2 justify-center mb-4",children:[1,2,3,4,5].map(i=>e.jsx("button",{onClick:()=>y(i),className:"p-1 transition-transform hover:scale-110",disabled:p,children:e.jsx(j,{className:`w-10 h-10 ${i<=o?"text-warning fill-warning":"text-muted-foreground"}`})},i))})]}),e.jsxs("div",{children:[e.jsx(X,{placeholder:t("reviews.shareFeedback"),value:d,onChange:i=>_(i.target.value),maxLength:500,disabled:p,className:"min-h-[100px]"}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1 text-right",children:[d.length,"/500"]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(l,{variant:"outline",className:"flex-1",onClick:()=>x("/"),disabled:p,children:t("common.cancel")}),e.jsx(l,{variant:"coral",className:"flex-1",onClick:U,disabled:p||o===0,children:p?t("common.loading")||"Enviando...":t("reviews.submitReview")})]})]})]}):e.jsxs("div",{className:"text-center py-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:"No se pudo cargar la información del establecimiento"}),e.jsx(h,{to:"/reviews",children:e.jsx(l,{variant:"coral",className:"w-full",children:t("reviews.rateNow")})})]})}),s.type==="promotion"&&e.jsx("div",{className:"mt-6 pt-6 border-t border-border",children:e.jsx(h,{to:"/search",children:e.jsx(l,{variant:"coral",className:"w-full",children:t("favorites.explorePlaces")})})})]})})]})};export{me as default};
